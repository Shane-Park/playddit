<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace = "users">
	<select id="selectAll" resultClass="UsersVO">
		select user_id
		from users
	</select>
	
	<!-- 아이디 중복체크 -->
	<select id="selectById" resultClass="String" parameterClass="String">
		select user_id from users
		where user_id = #user_id#
	</select>
	
	<!-- 팔로잉 목록 출력 -->
	<select id="followingList" resultClass="followerVO" parameterClass="String">
		select user_id as id, user_nickname as nickname,
        (select class_num ||' - ' || class_room from class where class_id=users.class_id) as department,
        nvl(user_pic,'default') as profile,
        (select count(*) from follow where follower = #user_id# and followee = users.user_id) as followback
		from users
		where user_id in (select followee
                from follow
                where follower = #user_id#)
	</select>
	<!-- 팔로워 목록 출력 -->
	<select id="followerList" resultClass="followerVO" parameterClass="String">
		select user_id as id, user_nickname as nickname,
        (select class_num ||' - ' || class_room from class where class_id=users.class_id) as department,
        nvl(user_pic,'default') as profile,
        (select count(*) from follow where follower = #user_id# and followee = users.user_id) as followback
		from users
		where user_id in (select follower
                from follow
                where followee = #user_id#)
	</select>
	
	<insert id="followUser" parameterClass="map">
		insert into follow 
		(follow_no, follower, followee)
		values(follow_no_seq.nextval, #follower#, #followee#)
	</insert>
	
	<delete id="unfollowUser" parameterClass="map">
		delete from follow
		where follower = #follower#
		and followee = #followee#
	</delete>
	
	<!-- 아이디 & 비밀번호 일치 여부 -->
	<select id="match" resultClass="UsersVO" parameterClass="map">
		select user_id, user_password, user_nickname
 		 from users
         where user_id=#user_id# and user_password=#user_pw#
	</select>
	
	<!-- 닉네임 중복검사 -->
	<select id="selectByNick" resultClass="String" parameterClass="String">
		select user_nickname
		  from users
		 where user_nickname = #user_nickname#
	</select>
	
	<!-- 비밀번호 변경 -->
	<update id="setNewPass" parameterClass="map">
		update users
		set user_password = #password#
		where user_id = #email#
	</update>
	
	<!-- 회원가입 -->
	<insert id="insertUser" parameterClass="UsersVO">
		 insert into users(user_id, user_nickname, user_password, user_name, user_tel, user_birth, user_theme, user_sign_date)
		 values (#user_id#, #user_nickname#, #user_password#, #user_name#, #user_tel#, #user_birth#, 0, sysdate)
		 
		 <!-- insert가 되었는지 안되었는지 selectKey로 확인할 수 있다. -->
 		 <selectKey resultClass="UsersVO" type="post">
		 	select user_id, user_nickname from users where user_id = #user_id#
		 </selectKey>
	</insert>
	
</sqlMap>

