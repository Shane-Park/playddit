<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace = "message">
	<select id="getClassMessage" parameterClass="String" resultClass="MessageVO">
		select class_msg.class_id as receiver, user_nickname as sender, msg_cont as content, msg_senddate as sentdate
		from class_msg, users
		where class_msg.class_id = #class_id#
		and msg_sender = user_id
		order by class_msg.cmsg_no
	</select>
	
	<select id="getMessage" parameterClass="map" resultClass="MessageVO">
		select b.user_nickname as receiver, c.user_nickname as sender, a.msg_content as content, to_char(a.msg_senddate,'yyyy-mm-dd hh24:mi:ss') as sentdate
		from message a, users b, users c
		where ((msg_sender = #user# and msg_target_id = #audience#)
		or (msg_target_id = #user# and msg_sender = #audience#))
		and a.msg_target_id = b.user_id
		and a.msg_sender = c.user_id
		order by msg_no
	</select>
	
	<select id="getAudiences" parameterClass="String" resultClass="audienceVO">
		select d.no, msg_content as content, b.user_id as id, b.user_nickname as nickname, 
				b.user_pic as profile,b.user_bio as bio,
		       (case when c.class_id = 'C000' then c.class_title
		                else c.class_num ||' - '|| c.class_room end) as classname
		from message a, users b, class c,
		    (select max(msg_no) as no,
		            (case when a.msg_target_id = d.user_id then a.msg_sender
		                        else a.msg_target_id end) as audience
		    from message a, users b, users c, users d
		    where (msg_sender = d.user_id or msg_target_id = d.user_id)
		      and a.msg_target_id = b.user_id
		      and a.msg_sender = c.user_id
		      and d.user_id = #user_id#
		    group by (case when a.msg_target_id = d.user_id then a.msg_sender
		                   else a.msg_target_id end)
		    order by max(msg_no) desc)d
		where a.msg_no = d.no
		    and b.user_id = d.audience
		    and b.class_id = c.class_id
	</select>
	
	<insert id="insertMessage" parameterClass="map">
		insert into message 
		(MSG_NO, MSG_TARGET_ID, MSG_SENDER, MSG_CONTENT, MSG_SENDDATE)
		values(msg_no_seq.nextval, #receiver#, #sender#, #content#, sysdate)
	</insert>
	
	<insert id="insertMessageClass" parameterClass="map">
		insert into class_msg 
		(cMSG_NO, class_id, MSG_SENDER, MSG_CONT, MSG_SENDDATE)
		values(cmsg_no_seq.nextval,#receiver#, #sender#, #content#, sysdate)
	</insert>
	
</sqlMap>

