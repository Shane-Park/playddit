<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace = "message">
	<select id="getMessage" parameterClass="map" resultClass="MessageVO">
		select b.user_nickname as receiver, c.user_nickname as sender, a.msg_content as content, to_char(a.msg_senddate,'yyyy-mm-dd hh24:mi:ss') as sentdate
		from message a, users b, users c
		where ((msg_sender = #user# and msg_target_id = #audience#)
		or (msg_target_id = #user# and msg_sender = #audience#))
		and a.msg_target_id = b.user_id
		and a.msg_sender = c.user_id
		order by msg_no
	</select>
	
	<select id="getAudiences" parameterClass="String" resultClass="UsersVO">
		select audience as user_nickname, (select user_id from users where user_nickname=audience) as user_id
		from
		(select case when (select user_nickname
		                    from users
		                    where user_id=#user_id#) = b.user_nickname then c.user_nickname
		            else b.user_nickname end as audience, a.msg_content, a.msg_senddate
		from message a, users b, users c
		where (msg_sender = #user_id# or msg_target_id = #user_id#)
		and a.msg_target_id = b.user_id
		and a.msg_sender = c.user_id
		order by msg_no desc)
		group by audience
	</select>
	
	<insert id="insertMessage" parameterClass="map">
		insert into message 
		(MSG_NO, MSG_TARGET_ID, MSG_SENDER, MSG_CONTENT, MSG_SENDDATE)
		values(msg_no_seq.nextval, #receiver#, #sender#, #content#, sysdate)
	</insert>
	
</sqlMap>

